@using UFF.Monopoly.Entities
@using UFF.Monopoly.Components.Pages.BoardBuilders
@using UFF.Monopoly.Components.Shared

@if (_showTip)
{
    <div class="evo-tooltip evo-tooltip-center">
        <div class="evo-tooltip-header d-flex align-items-center gap-3">
            <img src="@(ImageUrl.Replace(".png", "_detalhada.png"))" alt="img" class="evo-tooltip-img" />
        </div>
        @if (IsPropertyCard())
        {
            <div class="evo-tooltip-sub">Categoria: @BuildingType</div>
            <div class="evo-tooltip-price">Preço de compra: $ @Price</div>
            <div class="evo-tooltip-desc">@GetEvolutionDescription()</div>
        }
        else
        {
            <div class="evo-tooltip-rent">@GetSecondaryTooltipText()</div>
        }
        @if (!string.IsNullOrWhiteSpace(Description))
        {
            <div class="evo-tooltip-desc">@Description</div>
        }
    </div>
}


<div class="block-icon-wrapper" @onmouseover="ShowTip" @onmouseout="HideTip" @onclick:stopPropagation="true" @onclick="OnClickInternal">
    <div class="block-moldure @GetFrameClass()">
        <div class="moldure-title">
            <div class="title-text" title="@Name">@Name</div>
        </div>
        <div class="moldure-content">
            <img src="@ImageUrl" alt="@AltText" class="block-icon-img @( _animateImageChange ? "img-change" : string.Empty)" />
        </div>
        @if (HasLevelStars())
        {
            <div class="level-stars-overlay" aria-label="Nível da carta">
                @for (int i = 0; i < GetStarCount(); i++)
                {
                    <img src="/images/blocks/star_lvl_.png" alt="★" class="level-star" />
                }
            </div>
        }
    </div>
    @if (this.Type == BlockType.Property)
    {
        <div class="building-level-indicator">
            @for (int i = 0; i < this.BuildingLevel; i++)
            {
                <div class="building-level-unit @(this.BuildingType == BuildingType.House ? "house-unit" : "hotel-unit")"></div>
            }
        </div>
    }

    @if (!IsGoCard())
    {
        <div class="icon-info-bar @PriceThresholds.GetPriceClass(Price)" title="@GetTitleText()">
            @if (IsPropertyCard())
            {
                <span class="info-rent">R$ @Price</span>
            }
            else if (IsRevesCard())
            {
                <span class="info-rent">Volte @Rent casas</span>
            }
            else if(IsTaxCard())
            {
                <span class="info-rent">-@Rent</span>
            }
            else if (IsChanceCard())
            {
                <span class="info-rent">+R$@Rent</span>
            }
            else if (IsGoToJailCard())
            {
                <span class="info-rent">@Rent turnos</span>
            }
        </div>
    }
</div>

<style>
    /* 3D floating card effect */
    .block-icon-wrapper {
        position: relative;
        perspective: 1100px;
        overflow: unset !important; /* garante que a imagem possa "pular" para fora sem ser cortada */
        transform-style: preserve-3d;
    }

        .block-icon-wrapper::after { /* soft shadow behind card */
            content: "";
            position: absolute;
            left: 8%;
            top: 70%;
            width: 84%;
            height: 18%;
            background: radial-gradient(ellipse at center, rgba(0,0,0,.55) 0%, rgba(0,0,0,0) 70%);
            filter: blur(4px);
            transform: translateZ(-60px) scale(0.9);
            opacity: 0;
            transition: opacity .5s ease;
            pointer-events: none;
            z-index: 0;
        }

    .block-icon-img {
        position: relative;
        width: 100%;
        height: 100%;
        object-fit: contain; /* evita corte bruto mantendo proporção */
        transform-origin: center center;
        transform-style: preserve-3d;
        transition: transform .65s cubic-bezier(.19,1,.22,1), filter .55s ease, box-shadow .55s ease;
        will-change: transform, filter;
        animation: floatCard 7s ease-in-out infinite;
        z-index: 2;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,.55));
    }


    /* animação de "flutuar" suave */
    @@keyframes floatCard {
        0% {
            transform: translateY(0) translateZ(0) rotateX(0) rotateY(0);
        }

        25% {
            transform: translateY(-4px) translateZ(18px) rotateX(2deg) rotateY(-2deg);
        }

        50% {
            transform: translateY(-1px) translateZ(10px) rotateX(-1deg) rotateY(1deg);
        }

        75% {
            transform: translateY(-6px) translateZ(22px) rotateX(3deg) rotateY(-1deg);
        }

        100% {
            transform: translateY(0) translateZ(0) rotateX(0) rotateY(0);
        }
    }

    /* efeito de "saltar" ao hover */
    .block-icon-wrapper:hover .block-icon-img {
        animation-play-state: paused;
        transform: translateY(-8px) translateZ(60px) scale(1.08) rotateX(7deg) rotateY(-6deg);
        filter: drop-shadow(0 14px 18px rgba(0,0,0,.55)) brightness(1.08) saturate(1.1);
    }

    .block-icon-wrapper:hover::after {
        opacity: 1;
    }

    /* animação quando a imagem muda (já existia a flag .img-change) */
    .block-icon-img.img-change {
        animation: imageSwap .45s ease both;
    }

    @@keyframes imageSwap {
        0% {
            opacity: 0;
            transform: translateZ(-40px) scale(.85) rotateX(-8deg);
            filter: blur(6px);
        }

        60% {
            opacity: 1;
            filter: blur(0);
        }

        100% {
            opacity: 1;
            transform: translateZ(0) scale(1) rotateX(0);
        }
    }

    /* Remover estilo duplicado para moldura e frame variants, agora no CSS escopo */
    /* ... styles moved to BlockIcon.razor.css ... */
</style>
@code {
    [Parameter] public string ImageUrl { get; set; } = string.Empty;
    [Parameter] public string Name { get; set; } = string.Empty;
    [Parameter] public string Description { get; set; } = string.Empty;
    [Parameter] public int Price { get; set; }
    [Parameter] public int Rent { get; set; }
    [Parameter] public BlockType Type { get; set; }
    [Parameter] public BuildingType BuildingType { get; set; } = BuildingType.None;
    [Parameter] public int BuildingLevel { get; set; } = 0; // 0..4
    [Parameter] public EventCallback<Microsoft.AspNetCore.Components.Web.MouseEventArgs> OnClick { get; set; }
    [Parameter] public bool ShowRentTag { get; set; } = true;

    private bool _showTip;
    private string AltText => string.IsNullOrWhiteSpace(Name) ? "Bloco" : Name;
    private string? _lastImageUrl; private bool _animateImageChange;

    protected override void OnParametersSet()
    {
        if (_lastImageUrl != ImageUrl)
        {
            if (!string.IsNullOrEmpty(_lastImageUrl))
            {
                _animateImageChange = true;
                _ = Task.Run(async () => { try { await Task.Delay(450); } catch { } _animateImageChange = false; await InvokeAsync(StateHasChanged); });
            }
            _lastImageUrl = ImageUrl;
        }
    }

    private void OnClickInternal(Microsoft.AspNetCore.Components.Web.MouseEventArgs e) => OnClick.InvokeAsync(e);
    private void ShowTip(Microsoft.AspNetCore.Components.Web.MouseEventArgs e) { _showTip = true; _ = InvokeAsync(StateHasChanged); }
    private void HideTip() { _showTip = false; _ = InvokeAsync(StateHasChanged); }

    private string GetEvolutionDescription() { if (BuildingType == BuildingType.None || BuildingLevel < 1) return Description; var evo = BuildingEvolutionDescriptions.Get(BuildingType, Math.Clamp(BuildingLevel, 1, 4)); return $"{evo.Name}: {evo.Description}"; }

    private bool ShouldShowSecondaryTag() => ShowRentTag && (Type is BlockType.Tax or BlockType.Chance or BlockType.Reves) && Rent != 0;
    private bool IsPropertyCard() => Type is BlockType.Property or BlockType.Company;
    private bool IsChanceCard() => Type is BlockType.Chance;
    private bool IsTaxCard() => Type is BlockType.Tax;
    private bool IsRevesCard() => Type is BlockType.Reves;
    private bool IsGoCard() => Type is BlockType.Go;
    private bool IsGoToJailCard() => Type is BlockType.GoToJail;
    private string GetTitleText() => IsPropertyCard() ? $"{Name} ($ {Price})" : Name;
    private string GetSecondaryTagLabel() => Type switch { BlockType.Tax => "Taxa", BlockType.Chance => "Sorte", BlockType.Reves => "Revés", _ => "" };
    private string FormatSecondaryValue() => Type switch
    {
        BlockType.Tax => $"R$ {Rent}",
        BlockType.Chance => Rent >= 0 ? $"R$ {Rent}" : $"-R$ {Math.Abs(Rent)}",
        BlockType.Reves => $"{Rent} casas",
        _ => Rent.ToString()
    };
    private string GetSecondaryTooltipText() => Type switch
    {
        BlockType.Tax => $"Taxa fixa: $ {Rent}",
        BlockType.Chance => Rent >= 0 ? $"Valor sorte aplicado: $ {Rent}" : $"Valor sorte aplicado: -$ {Math.Abs(Rent)}",
        BlockType.Reves => $"Volta {Rent} casas ao cair aqui",
        BlockType.GoToJail => $"Prisão por {Rent} turno(s)",
        _ => string.Empty
    };

    private string GetFrameClass()
    {
        // Property/Company families keep their own frames
        if (Type == BlockType.Property)
        {
            return BuildingType switch
            {
                BuildingType.House => "frame-house",
                BuildingType.Hotel => "frame-hotel",
                BuildingType.Company => "frame-company",
                BuildingType.Special => "frame-special",
                _ => string.Empty
            };
        }
        if (Type == BlockType.Company)
            return "frame-company";

        // Special cards (powerups/debuffs) by BlockType
        return Type switch
        {
            BlockType.Tax or BlockType.Reves or BlockType.GoToJail => "frame-debuff", // debuffs
            BlockType.Chance => "frame-gold", // gold
            BlockType.Go => "frame-go", // gold
            BlockType.FreeParking => "frame-freeparking", // buffs
            _ => "frame-powerup" // demais tratamos como buff
        };
    }

    private bool HasLevelStars()
    {
        // Only Property, Company types show levels
        if (!(Type == BlockType.Property || Type == BlockType.Company)) return false;
        // Specials always show (5), others if level > 0
        if (BuildingType == BuildingType.Special) return true;
        return BuildingLevel > 0;
    }

    private int GetStarCount()
    {
        if (Type != BlockType.Property && Type != BlockType.Company) return 0;
        return BuildingType switch
        {
            BuildingType.Special => 5,
            BuildingType.House or BuildingType.Hotel or BuildingType.Company => Math.Max(0, BuildingLevel),
            _ => 0
        };
    }
}
