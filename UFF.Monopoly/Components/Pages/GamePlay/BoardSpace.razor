@using UFF.Monopoly.Models
@using UFF.Monopoly.Components.Shared
@using UFF.Monopoly.Entities
@inherits ComponentBase

<div id="@Space.Id" class="board-space" style="@BuildStyle()" @onclick="() => OnClick.InvokeAsync(Space)">
    <div class="space-inner">
        <BlockIcon ImageUrl="@Space.ImageUrl" Name="@Space.Name" Description="" Price="@Space.Price" Rent="@Space.Rent" Type="@Space.Type" BuildingType="@Space.BuildingType" BuildingLevel="@Space.BuildingLevel" ShowRentTag="true" />
        @if (Space.OwnerPlayerIndex.HasValue)
        {
            <div class="owner-overlay" style="background:@GetOwnerColor(Space.OwnerPlayerIndex.Value);"></div>
            @if (PawnUrlResolver is not null)
            {
                var pawnUrl = PawnUrlResolver.Invoke(Space.OwnerPlayerIndex.Value);
                <img src="@pawnUrl" alt="dono" class="owner-center-img" />
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public BoardSpaceDto Space { get; set; } = new();

    [Parameter]
    public EventCallback<BoardSpaceDto> OnClick { get; set; }

    [CascadingParameter] public string[]? OwnerColors { get; set; }

    // Resolvedor de URL do peão do jogador dono
    [Parameter] public Func<int, string>? PawnUrlResolver { get; set; }

    private string BuildStyle()
    {
        var style = new System.Text.StringBuilder();
        style.Append("position:absolute;");
        style.Append($"top:{Space.Style.Top};");
        style.Append($"left:{Space.Style.Left};");
        style.Append($"width:{Space.Style.Width};");
        style.Append($"height:{Space.Style.Height};");
        // expor variável para dimensionamento interno
        style.Append($"--cell-size:{Space.Style.Width};");
        if (!string.IsNullOrWhiteSpace(Space.Style.Transform))
        {
            style.Append($"transform:{Space.Style.Transform};");
        }
        return style.ToString();
    }

    private string GetOwnerColor(int index)
    {
        if (OwnerColors is null || OwnerColors.Length == 0) return "rgba(255,255,255,0.25)";
        return index < OwnerColors.Length ? OwnerColors[index] + "99" : "rgba(255,255,255,0.25)"; // adicionar translucência
    }
}
