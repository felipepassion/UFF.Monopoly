@using UFF.Monopoly.Entities
@using UFF.Monopoly.Data.Entities
@using UFF.Monopoly.Components.Pages.BoardBuilders
@using UFF.Monopoly.Components.Shared
@inherits ComponentBase

@if (Block is not null && Player is not null)
{
    @if (Block.Type == BlockType.Property || Block.Type == BlockType.Company)
    {
        var statePb = Block as PropertyBlock;
        var displayName = TemplateEntity?.Name ?? Block.Name;
        var buildingType = statePb?.BuildingType ?? TemplateEntity?.BuildingType ?? BuildingType.None;
        var currentLevel = statePb?.BuildingLevel ?? Math.Clamp(1, 1, 4); // default preview level when not built
        var nextLevel = currentLevel + 1;
        var maxLevel = 4;
        BuildingEvolutionDescriptions.EvolutionInfo? nextInfo = null;
        if (buildingType != BuildingType.None && buildingType != BuildingType.Special && nextLevel >= 1 && nextLevel <= maxLevel)
        {
            nextInfo = BuildingEvolutionDescriptions.Get(buildingType, Math.Clamp(nextLevel, 1, 4));
        }
        BuildingEvolutionDescriptions.EvolutionInfo? currentInfo = null;
        if (buildingType != BuildingType.None && buildingType != BuildingType.Special && currentLevel >= 1 && currentLevel <= maxLevel)
        {
            currentInfo = BuildingEvolutionDescriptions.Get(buildingType, Math.Clamp(currentLevel, 1, 4));
        }
        var terrenoTitle = buildingType switch { BuildingType.House => "Terreno (Casa)", BuildingType.Company => "Terreno (Empresa)", BuildingType.Hotel => "Terreno (Hotél)", _ => (Block.Type == BlockType.Company ? "Companhia" : "Propriedade") };
        <div class="popup-info animate-pop">
            <div class="header d-flex align-items-center gap-3">
                <div class="thumb">
                    @ChildContent
                </div>
                <div class="title-area">
                    <div class="name h5 mb-1">@terrenoTitle</div>
                    <div class="display-name h6 mb-0">@displayName</div>
                </div>
            </div>

            <div class="info-grid mt-3">
                <div>
                    <div class="label">Preço</div>
                    <div class="value">R$ @Block.Price</div>
                </div>
                @if (statePb is not null && statePb.BuildingType != BuildingType.None)
                {
                    <div>
                        <div class="label">Aluguel atual</div>
                        <div class="value">R$ @statePb.CalculateRent()</div>
                    </div>
                }
                else
                {
                    <div>
                        <div class="label">Aluguel fixo</div>
                        <div class="value">R$ @Block.Rent</div>
                    </div>
                }
            </div>

            @if (buildingType != BuildingType.None && buildingType != BuildingType.Special)
            {
                <div class="details mt-3">
                    <div class="level-line d-flex align-items-center gap-2">
                        <span class="label fw-semibold">Nível</span>
                        <span class="badge rounded-pill bg-dark">@currentLevel</span>
                        @if (nextInfo is not null && currentLevel < maxLevel)
                        {
                            <span class="arrow">→</span>
                            <span class="badge rounded-pill bg-primary" title="Próximo nível">@nextLevel</span>
                        }
                        <span class="max text-muted small">/@maxLevel</span>
                    </div>

                    <EvolutionStrip
                                    BuildingType="@buildingType"
                                    CurrentLevel="@currentLevel"
                                    NextLevel="@nextLevel"
                                    MaxLevel="@maxLevel"
                                    CurrentInfo="@currentInfo"
                                    NextInfo="@nextInfo"
                                    GetBuildingImage="@GetBuildingImage" />

                    <div class="mt-2"><span class="label">Tipo construção</span> <span class="value">@buildingType</span></div>
                    @if (currentInfo is not null)
                    {
                        <div class="evo-desc small text-muted mt-2">Atual: <em>@currentInfo.Name</em> - @currentInfo.Description</div>
                    }
                    @if (nextInfo is not null)
                    {
                        <div class="evo-next small mt-1">Próximo: <em>@nextInfo.Name</em> - @nextInfo.Description</div>
                    }
                </div>
            }

            <div class="actions mt-3">
                @if ((Block.Owner) is null && !IsBotTurn)
                {
                    <button id="btnBuy" class="btn btn-success me-2" @onclick="OnBuy" disabled="@(Player.Money < Block.Price)">Comprar (R$ @Block.Price)</button>
                }
                else if (statePb?.Owner == Player && !IsBotTurn)
                {
                    <button id="btnUpgrade" class="btn btn-primary me-2" @onclick="OnUpgrade" disabled="@(!(statePb is not null && CanUpgradeAllowed))">Evoluir nível @nextLevel (R$ @NextUpgradeCost)</button>
                    <button class="btn btn-outline-danger" @onclick="OnSell">Vender propriedade (50%)</button>
                }
                else if (IsBotTurn)
                {
                    <div class="text-muted small">Bot está jogando...</div>
                }
                else
                {
                    <div class="text-muted">Propriedade de: @Block.Owner?.Name</div>
                }
            </div>
        </div>
    }
    else
    {
        @ChildContent
    }
}

@code {
    [Parameter] public Block? Block { get; set; }
    [Parameter] public Player? Player { get; set; }
    [Parameter] public BlockTemplateEntity? TemplateEntity { get; set; }
    [Parameter] public bool CanUpgradeAllowed { get; set; }
    [Parameter] public int NextUpgradeCost { get; set; }
    [Parameter] public EventCallback OnBuy { get; set; }
    [Parameter] public EventCallback OnUpgrade { get; set; }
    [Parameter] public EventCallback OnSell { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [CascadingParameter] public bool IsBotTurn { get; set; }
    [Parameter] public Func<BuildingType, int, string>? GetBuildingImage { get; set; }
}

<style>
/* Scoped styles to improve visual hierarchy */
.popup-info { padding: .25rem .5rem 0; max-width: 560px; }
/* fade+scale animation on updates (buy/evolve) */
.animate-pop { animation: popFade .22s ease-out; }
@@keyframes popFade { from { opacity: 0; transform: scale(.98); } to { opacity: 1; transform: scale(1); } }

.popup-info .header .thumb { width: 72px; height: 72px; flex: 0 0 auto; border-radius: .5rem; overflow: hidden; background: rgba(255,255,255,.05); }
.popup-info .title-area .name { font-weight: 600; }
.popup-info .title-area .display-name { color: var(--bs-light); }

.popup-info .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem 1rem; }
.popup-info .label { color: var(--bs-secondary-color, #adb5bd); font-size: .9rem; }
.popup-info .value { font-weight: 600; }

.popup-info .level-line .arrow { opacity: .7; }
.popup-info .max { margin-left: .25rem; }

/* actions area resilient width */
.popup-info .actions { display: flex; align-items: center; flex-wrap: wrap; gap: .5rem; }
</style>
