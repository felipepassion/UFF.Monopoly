@using UFF.Monopoly.Entities
@using UFF.Monopoly.Data.Entities
@using UFF.Monopoly.Components.Pages.BoardBuilders
@using UFF.Monopoly.Components.Shared
@using UFF.Monopoly.Components.Pages.GamePlay.Modals
@inherits ComponentBase

@if (Block is not null && Player is not null)
{
    @if (Block.Type == BlockType.Property || Block.Type == BlockType.Company)
    {
        var statePb = Block as PropertyBlock;
        var displayName = TemplateEntity?.Name ?? Block.Name;
        var buildingType = statePb?.BuildingType ?? TemplateEntity?.BuildingType ?? BuildingType.None;
        var currentLevel = statePb?.BuildingLevel ?? Math.Clamp(1, 1, 4); // default preview level when not built
        var nextLevel = currentLevel + 1;
        var maxLevel = 4;
        BuildingEvolutionDescriptions.EvolutionInfo? nextInfo = null;
        if (buildingType != BuildingType.None && buildingType != BuildingType.Special && nextLevel >= 1 && nextLevel <= maxLevel)
        {
            nextInfo = BuildingEvolutionDescriptions.Get(buildingType, Math.Clamp(nextLevel, 1, 4));
        }
        BuildingEvolutionDescriptions.EvolutionInfo? currentInfo = null;
        if (buildingType != BuildingType.None && buildingType != BuildingType.Special && currentLevel >= 1 && currentLevel <= maxLevel)
        {
            currentInfo = BuildingEvolutionDescriptions.Get(buildingType, Math.Clamp(currentLevel, 1, 4));
        }
        var terrenoTitle = buildingType switch { BuildingType.House => "Terreno (Casa)", BuildingType.Company => "Terreno (Empresa)", BuildingType.Hotel => "Terreno (HotÃ©l)", _ => (Block.Type == BlockType.Company ? "Companhia" : "Propriedade") };

        <div class="popup-info animate-pop" role="dialog" aria-modal="true" aria-label="@terrenoTitle">
            <PropertyModalHeader DisplayName="@displayName" Title="@terrenoTitle">
                @ChildContent
            </PropertyModalHeader>

            <PropertyModalBody Block="@Block"
                               StatePb="@statePb"
                               BuildingType="@buildingType"
                               CurrentLevel="@currentLevel"
                               NextLevel="@nextLevel"
                               MaxLevel="@maxLevel"
                               CurrentInfo="@currentInfo"
                               NextInfo="@nextInfo"
                               GetBuildingImage="@GetBuildingImage" />

            <PropertyModalFooter Block="@Block"
                                 Player="@Player"
                                 StatePb="@statePb"
                                 CanUpgradeAllowed="@CanUpgradeAllowed"
                                 NextUpgradeCost="@NextUpgradeCost"
                                 NextLevel="@nextLevel"
                                 OnBuy="@OnBuy"
                                 OnUpgrade="@OnUpgrade"
                                 OnSell="@OnSell" />
        </div>
    }
    else
    {
        @ChildContent
    }
}

@code {
    [Parameter] public Block? Block { get; set; }
    [Parameter] public Player? Player { get; set; }
    [Parameter] public BlockTemplateEntity? TemplateEntity { get; set; }
    [Parameter] public bool CanUpgradeAllowed { get; set; }
    [Parameter] public int NextUpgradeCost { get; set; }
    [Parameter] public EventCallback OnBuy { get; set; }
    [Parameter] public EventCallback OnUpgrade { get; set; }
    [Parameter] public EventCallback OnSell { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [CascadingParameter] public bool IsBotTurn { get; set; }
    [Parameter] public Func<BuildingType, int, string>? GetBuildingImage { get; set; }
}

<style>
    /* Modal container and animation retained */
    .popup-info {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: .25rem;
        padding: .5rem .5rem 0;
        max-width: 640px;
        max-height: min(72vh, 680px);
        backdrop-filter: saturate(1.2) blur(3px);
        background: rgba(24, 26, 27, .75);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: .6rem;
    }

    .animate-pop {
        animation: popFade .22s ease-out;
    }

    @@keyframes popFade {
        from {
            opacity: 0;
            transform: scale(.98);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* legacy selectors for nested components */
    .popup-info .header .thumb,
    .popup-header .thumb {
        width: 64px;
        height: 64px;
        flex: 0 0 auto;
        border-radius: .5rem;
        overflow: hidden;
        background: rgba(255,255,255,.05);
    }

    .popup-info .title-area .name {
        font-weight: 600;
    }

    .popup-info .title-area .display-name {
        color: var(--bs-light);
    }

    /* Body scroll and footer stickiness provided by nested components */
    .popup-body {
        overflow: auto;
        padding: .25rem .25rem .5rem;
    }

    .popup-footer {
        position: sticky;
        bottom: 0;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: .5rem;
        padding: .5rem .5rem;
        background: linear-gradient(to bottom, rgba(24,26,27,0.6), rgba(24,26,27,0.85));
        border-top: 1px solid rgba(255,255,255,.08);
        box-shadow: 0 -4px 10px rgba(0,0,0,.15);
        justify-content:center;
    }

    /* grid */
    .popup-info .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: .5rem .75rem;
    }

    .popup-info .label {
        color: #adb5bd;
        font-size: .9rem;
    }

    .popup-info .value {
        font-weight: 600;
    }

    .popup-info .level-line .arrow {
        opacity: .7;
    }

    .popup-info .max {
        margin-left: .25rem;
    }

    /* actions area resilient width */
    .popup-info .actions {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: .5rem;
    }
</style>
