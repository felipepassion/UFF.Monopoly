@using UFF.Monopoly.Entities
@using UFF.Monopoly.Data.Entities
@inherits ComponentBase

@if (Show && Block is not null && Player is not null)
{
    <div class="modal-backdrop show" style="z-index:@(BaseZ)"></div>
    <div class="modal d-block" tabindex="-1" style="z-index:@(BaseZ + 1)">
        <div class="modal-dialog modal-md modal-center">
            <div class="modal-content p-2 modal-surface property-modal">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title">@Block.Name</h5>
                    @if (!IsBotTurn)
                    {
                        <button type="button" class="btn-close btn-close-white" aria-label="Fechar" @onclick="OnClose"></button>
                    }
                </div>
                <div class="modal-body">
                    <div class="property-modal-body">
                        <div class="property-icon position-relative">
                            <img src="@GetIconForBlock(Block)" alt="icon" />
                            @if (Block is PropertyBlock pb && pb.BuildingLevel > 0)
                            {
                                <div class="evolution-flash lv-@pb.BuildingLevel"></div>
                            }
                        </div>
                        <div class="property-info">
                            <div class="prop-line name">@Block.Name</div>
                            <div class="prop-line price">Preço: R$ @Block.Price</div>
                            <div class="prop-line rent">Aluguel: R$ @Block.Rent</div>
                        </div>
                    </div>
                    @ChildContent
                </div>
                <div class="modal-footer d-flex justify-content-end gap-2">
                    @if ((Block.Type == BlockType.Property || Block.Type == BlockType.Company) && Block.Owner is null && !Block.IsMortgaged && !IsBotTurn)
                    {
                        <button class="btn btn-success" @onclick="OnBuy" disabled="@(Player.Money < Block.Price)">Comprar (R$ @Block.Price)</button>
                    }
                    @if (!IsBotTurn)
                    {
                        <button class="btn btn-secondary" @onclick="OnClose">Fechar</button>
                    }
                    @if (IsBotTurn)
                    {
                        <div class="text-muted small">Bot está jogando...</div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public Block? Block { get; set; }
    [Parameter] public Player? Player { get; set; }
    [Parameter] public BlockTemplateEntity? TemplateEntity { get; set; }
    [Parameter] public int BaseZ { get; set; } = 22000;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnBuy { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [CascadingParameter] public bool IsBotTurn { get; set; } // injetado a partir da página

    private string GetIconForBlock(Block b)
    {
        if (b is PropertyBlock pb)
        {
            if (pb.BuildingType == BuildingType.Company) return "/images/blocks/property_predio.svg";
            if (pb.BuildingType == BuildingType.Hotel) return "/images/board/buildings/hotel1.png";
            if (pb.BuildingType == BuildingType.House) return "/images/board/buildings/house1.png";
            if (pb.BuildingType == BuildingType.Special) return "/images/board/buildings/special_circus.png";
            return "/images/blocks/property_basic.svg";
        }
        if (b.Type == BlockType.Company) return "/images/blocks/property_predio.svg";
        return "/images/blocks/property_basic.svg";
    }
}
