@using UFF.Monopoly.Entities
@using UFF.Monopoly.Data.Entities
@inherits ComponentBase

@if (Show && Block is not null && Player is not null)
{
    <div class="modal-backdrop show" style="z-index:@(BaseZ)"></div>
    <div class="modal d-block" tabindex="-1" style="z-index:@(BaseZ + 1)">
        <div class="modal-dialog modal-xl modal-center" style="min-width:680px; max-width:1100px;">
            <div class="modal-content p-3 p-md-4 modal-surface property-modal animate-pop">
                <div class="modal-header">
                    <h5 class="modal-title">@Block.Name</h5>
                    @if (!IsBotTurn)
                    {
                        <button type="button" class="btn-close btn-close-white" aria-label="Fechar" @onclick="OnClose"></button>
                    }
                </div>
                <div class="modal-body">
                    <div class="property-modal-body centered">
                        <div class="property-icon position-relative">
                            <img src="@GetPreviewImage(Block).Replace(".png","_detalhada.png")" alt="icon" class="icon-img hero-icon" />
                            @if (Block is PropertyBlock pb && pb.BuildingLevel > 0)
                            {
                                <div class="evolution-flash lv-@pb.BuildingLevel"></div>
                            }
                        </div>
                        <div class="property-info">
                            <div class="prop-line name fw-semibold display-name">@Block.Name</div>
                            <div class="prop-stats">
                                <span class="stat-chip">Preço: R$ @Block.Price</span>
                                <span class="stat-chip">Aluguel: R$ @(Block is PropertyBlock pb2 ? pb2.CalculateRent() : Block.Rent)</span>
                            </div>
                        </div>
                    </div>
                    <div class="property-description centered">
                        @ChildContent
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-end gap-2">
                    @if (!IsBotTurn)
                    {
                        <button class="btn btn-secondary btn-lg" @onclick="OnClose">Fechar</button>
                    }
                    @if (IsBotTurn)
                    {
                        <div class="text-muted small">Bot está jogando...</div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public Block? Block { get; set; }
    [Parameter] public Player? Player { get; set; }
    [Parameter] public BlockTemplateEntity? TemplateEntity { get; set; }
    [Parameter] public int BaseZ { get; set; } = 22000;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnBuy { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [CascadingParameter] public bool IsBotTurn { get; set; } // injetado a partir da página

    private string GetPreviewImage(Block b)
    {
        // Usa imagem atual do bloco se já definida (garante especiais e evolução)
        if (!string.IsNullOrWhiteSpace(b.ImageUrl)) return b.ImageUrl;
        return GetIconForBlock(b);
    }

    private string GetIconForBlock(Block b)
    {
        if (b is PropertyBlock pb)
        {
            // Usa imagem evoluída se disponível
            if (!string.IsNullOrWhiteSpace(pb.ImageUrl)) return pb.ImageUrl;
            if (pb.BuildingType == BuildingType.Company) return "/images/blocks/property_predio.svg";
            if (pb.BuildingType == BuildingType.Hotel) return "/images/blocks/hotel1.png";
            if (pb.BuildingType == BuildingType.House) return "/images/blocks/house1.png";
            if (pb.BuildingType == BuildingType.Special) return "/images/blocks/special_circus.png";
            return "/images/blocks/property_basic.svg";
        }
        if (b.Type == BlockType.Company) return "/images/blocks/property_predio.svg";
        return "/images/blocks/property_basic.svg";
    }
}

<style>
/* Popup animation */
.animate-pop { animation: popFade .22s ease-out; }
@@keyframes popFade { from { opacity: 0; transform: scale(.96); } to { opacity: 1; transform: scale(1); } }

/* Center the dialog vertically */
.modal-center { display:flex; align-items:center; min-height: calc(100vh - 3rem); }

/* Modal surface makeover */
.property-modal.modal-surface {
    border-radius: 22px;
    background:
        radial-gradient(1200px 400px at 10% -10%, rgba(104,197,255,.08), transparent 40%),
        radial-gradient(800px 300px at 120% 120%, rgba(140,255,199,.06), transparent 40%),
        linear-gradient(180deg, #0f1a22 0%, #0c151b 100%);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 28px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.05) inset;
}

/* Softer header divider and larger title */
.property-modal .modal-header { border-bottom: 1px solid rgba(255,255,255,.08) !important; }
.property-modal .modal-title { font-size: 1.35rem; letter-spacing:.2px; }

/* Body stacked and centered */
.property-modal .property-modal-body.centered { display:flex; flex-direction:column; align-items:center; text-align:center; gap:1.1rem; }

/* Big hero image - guaranteed large */
.property-modal .icon-img { object-fit: contain; border-radius: 1rem; display:block; }
.property-modal .icon-img.hero-icon {
    width: clamp(320px, 40vw, 560px);
    height: clamp(320px, 40vw, 560px);
    padding: 10px;
    background: linear-gradient(145deg,#0f1c24,#1e2e38);
    box-shadow: 0 20px 44px -8px rgba(0,0,0,.78), 0 0 0 1px rgba(255,255,255,.1);
}

/* Name and stats */
.property-modal .property-info { display:flex; flex-direction:column; gap:.6rem; }
.property-modal .display-name { font-size: clamp(1.4rem, 2.4vw, 2rem); letter-spacing:.2px; }
.property-modal .prop-stats { display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap; }
.property-modal .stat-chip {
    font-size: 1.05rem;
    padding: .5rem .85rem;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: .85rem;
}

/* Description (ChildContent) spacing and size */
.property-modal .property-description { margin-top: 1rem; font-size: 1.15rem; }
.property-modal .property-description.centered { text-align:center; max-width: 900px; margin-inline:auto; }

/* Ensure footer buttons wrap nicely */
.property-modal .modal-footer { flex-wrap: wrap; }
</style>
