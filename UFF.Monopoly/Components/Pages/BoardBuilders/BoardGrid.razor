@using UFF.Monopoly.Data.Entities
@using UFF.Monopoly.Entities
@using UFF.Monopoly.Components.Shared
@inherits ComponentBase
<div class="board-grid" style="grid-template-columns: repeat(@Cols, @(CellSize + "px")); grid-auto-rows: @(CellSize + "px");">
    @for (var r = 0; r < Rows; r++)
    {
        for (var c = 0; c < Cols; c++)
        {
            if (CellToIndex.TryGetValue((r, c), out var index))
            {
                var b = index >= 0 && index < Blocks.Count ? Blocks[index] : null; 
                if (b is null)
                {
                    <div class="grid-cell empty"></div>
                }
                else
                {
                    <div class="grid-cell perimeter position-relative" style="background:@GetCellBackground(b); color:@GetTextColor(GetCellBackground(b));" title="@($"{TranslateBlockType(b.Type)} - {b.Name}")">
                        <BlockIcon ImageUrl="@b.ImageUrl"
                                   Name="@b.Name"
                                   Description="@b.Description"
                                   Price="@b.Price"
                                   Rent="@b.Rent"
                                   Type="@b.Type"
                                   BuildingType="@b.BuildingType"
                                   BuildingLevel="@((int)(b.Level ?? 0))"
                                   OnClick="@(e => OnCellClick?.Invoke(index, e))" />
                    </div>
                }
            }
            else
            {
                <div class="grid-cell empty"></div>
            }
        }
    }
</div>
@code {
    [Parameter] public int Rows { get; set; }
    [Parameter] public int Cols { get; set; }
    [Parameter] public int CellSize { get; set; }
    [Parameter] public List<BlockTemplateEntity> Blocks { get; set; } = new(); 
    [Parameter] public Dictionary<(int r, int c), int> CellToIndex { get; set; } = new(); 
    [Parameter] public Func<BlockTemplateEntity, string> GetCellBackground { get; set; } = default!; 
    [Parameter] public Func<BlockType, string> TranslateBlockType { get; set; } = default!; 
    [Parameter] public Action<int, Microsoft.AspNetCore.Components.Web.MouseEventArgs>? OnCellClick { get; set; }
    private string GetTextColor(string? bg) { if (string.IsNullOrWhiteSpace(bg)) return "#111827"; try { if (bg.StartsWith("#") && bg.Length == 7) { var r = Convert.ToInt32(bg.Substring(1, 2), 16); var g = Convert.ToInt32(bg.Substring(3, 2), 16); var b = Convert.ToInt32(bg.Substring(5, 2), 16); var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000; return yiq >= 128 ? "#111827" : "#ffffff"; } } catch { } return "#111827"; }
}
