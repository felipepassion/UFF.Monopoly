@page "/local"

@using Microsoft.EntityFrameworkCore
@using UFF.Monopoly.Data
@using UFF.Monopoly.Data.Entities
@using UFF.Monopoly.Models
@using UFF.Monopoly.Repositories
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IGameRepository GameRepo
@inject NavigationManager Nav

<div class="d-flex align-items-center justify-content-center" style="min-height: calc(100vh - 80px);">
    <div class="card p-4" style="background:var(--surface); border:1px solid rgba(255,255,255,0.04); width:720px;">
        <h2 class="mb-3">Local</h2>

        <div class="mb-3">
            <label class="form-label" style="color:var(--text);">Tabuleiro</label>
            <select class="form-select" @bind="SelectedBoardId">
                @if (Boards is not null)
                {
                    @foreach (var b in Boards)
                    {
                        <option value="@b.Id">@b.Name (@b.Rows x @b.Cols)</option>
                    }
                }
            </select>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-6">
                <label class="form-label" style="color:var(--text);">Jogadores (humanos)</label>
                <input type="number" class="form-control" min="1" max="4" @bind="HumanCount" />
            </div>
            <div class="col-6">
                <label class="form-label" style="color:var(--text);">Bots</label>
                <input type="number" class="form-control" min="0" max="3" @bind="BotCount" />
            </div>
        </div>

        <div class="mb-3">
            <div class="fw-semibold mb-2" style="color:var(--text);">Nome dos jogadores</div>
            @for (int i = 0; i < HumanCount; i++)
            {
                <div class="input-group mb-2">
                    <button class="btn btn-outline-light" style="width:44px;padding:4px 6px;" @onclick="(() => ShowPawnPicker(i))">
                        <img src="@GetPawnUrlFor(i)" alt="pawn" style="width:28px;height:28px;object-fit:contain;" />
                    </button>
                    <span class="input-group-text">#{i + 1}</span>
                    <input class="form-control" @bind="HumanNames[i]" />
                </div>
            }

            @for (int j = 0; j < BotCount; j++)
            {
                <div class="input-group mb-2">
                    <span class="input-group-text">Bot #{j + 1}</span>
                    <input class="form-control" value="@($"Bot {j + 1}")" disabled />
                </div>
            }
        </div>

        @if (_pawnPickerFor >= 0)
        {
            <div class="modal-backdrop show"></div>
            <div class="modal d-block" tabindex="-1">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content p-2" style="background:var(--surface);border:1px solid rgba(255,255,255,0.04);">
                        <div class="modal-header">
                            <h6 class="modal-title">Escolha um peão</h6>
                            <button type="button" class="btn-close btn-close-white" aria-label="Close" @onclick="ClosePawnPicker"></button>
                        </div>
                        <div class="modal-body d-flex flex-wrap gap-2 p-2">
                            @for (int p = 1; p <= 6; p++)
                            {
                                var idx = p;
                                var url = $"{Nav.BaseUri}images/pawns/PawnsB{p}.png";
                                var takenBy = SelectedPawns.IndexOf(p);
                                var disabled = takenBy >= 0 && takenBy != _pawnPickerFor;
                                <button class="btn p-0 border" style="width:64px;height:64px;" disabled="@disabled" @onclick="(() => PickPawnFor(_pawnPickerFor, idx))">
                                    <img src="@url" style="width:100%;height:100%;object-fit:contain;opacity:@(disabled ? 0.35 : 1)" />
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small" style="color:var(--text-muted);">Você deve ter pelo menos 1 jogador humano. Total de jogadores até 4.</div>
            <div>
                <button class="btn btn-secondary me-2" @onclick="Back">Voltar</button>
                <button class="btn btn-primary" @onclick="StartLocalGame" disabled="@(!CanStart)">Iniciar Jogo Local</button>
            </div>
        </div>
    </div>
</div>

@code {
    private List<BoardDefinitionEntity> Boards = new();
    private Guid SelectedBoardId = Guid.Empty;

    private int _humanCount = 1;
    private int HumanCount
    {
        get => _humanCount;
        set
        {
            _humanCount = Math.Clamp(value, 1, 4);
            EnsureHumanNamesSize();
            EnsureSelectedPawnsSize();
        }
    }

    private int _botCount = 0;
    private int BotCount
    {
        get => _botCount;
        set
        {
            _botCount = Math.Clamp(value, 0, 3);
            // enforce total players <=4
            if (HumanCount + _botCount > 4) _botCount = 4 - HumanCount;
            EnsureSelectedPawnsSize();
        }
    }

    private List<string> HumanNames = new() { "Player 1", "Player 2", "Player 3", "Player 4" };

    // Selected pawn index (1..6) per player (humans followed by bots)
    private List<int> SelectedPawns = new() { 1, 2, 3, 4 };

    private int _pawnPickerFor = -1;

    private bool CanStart => HumanCount >= 1 && HumanCount <= 4 && BotCount >= 0 && BotCount <= 3 && (HumanCount + BotCount) <= 4 && SelectedBoardId != Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadBoardsAsync();
        if (Boards.Any()) SelectedBoardId = Boards[0].Id;
        EnsureHumanNamesSize();
        EnsureSelectedPawnsSize();
    }

    private void EnsureHumanNamesSize()
    {
        while (HumanNames.Count < 4) HumanNames.Add($"Player {HumanNames.Count + 1}");
        // trim is not necessary; we keep up to 4
    }

    private void EnsureSelectedPawnsSize()
    {
        while (SelectedPawns.Count < 4) SelectedPawns.Add(SelectedPawns.Count + 1);
        // ensure uniqueness naive: if duplicates exist, try to assign available
        var used = new HashSet<int>();
        for (int i = 0; i < SelectedPawns.Count; i++)
        {
            if (used.Contains(SelectedPawns[i]) || SelectedPawns[i] < 1 || SelectedPawns[i] > 6)
            {
                // find first available
                for (int p = 1; p <= 6; p++)
                {
                    if (!used.Contains(p)) { SelectedPawns[i] = p; used.Add(p); break; }
                }
            }
            else used.Add(SelectedPawns[i]);
        }
    }

    private string GetPawnUrlFor(int playerIndex)
    {
        var idx = SelectedPawns.ElementAtOrDefault(playerIndex);
        if (idx < 1 || idx > 6) idx = 1;
        return $"{Nav.BaseUri}images/pawns/PawnsB{idx}.png";
    }

    private void ShowPawnPicker(int playerIndex)
    {
        _pawnPickerFor = playerIndex;
    }

    private void ClosePawnPicker()
    {
        _pawnPickerFor = -1;
    }

    private void PickPawnFor(int playerIndex, int pawnIdx)
    {
        // ensure pawn not used by others
        if (SelectedPawns.IndexOf(pawnIdx) >= 0 && SelectedPawns.IndexOf(pawnIdx) != playerIndex)
            return;
        SelectedPawns[playerIndex] = pawnIdx;
        _pawnPickerFor = -1;
    }

    private async Task LoadBoardsAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        Boards = await db.Boards.AsNoTracking().OrderByDescending(b => b.CreatedAt).ToListAsync();
    }

    private void Back()
    {
        Nav.NavigateTo("/");
    }

    private async Task StartLocalGame()
    {
        if (!CanStart) return;

        var players = new List<string>();
        var pawnIndices = new List<int>();
        for (int i = 0; i < HumanCount; i++)
        {
            var name = HumanNames.ElementAtOrDefault(i) ?? $"Player {i + 1}";
            name = string.IsNullOrWhiteSpace(name) ? $"Player {i + 1}" : name.Trim();
            players.Add(name);
            pawnIndices.Add(SelectedPawns.ElementAtOrDefault(i));
        }
        for (int j = 0; j < BotCount; j++)
        {
            players.Add($"Bot {j + 1}");
            pawnIndices.Add(SelectedPawns.ElementAtOrDefault(HumanCount + j));
        }

        var (gameId, game) = await GameRepo.CreateNewGameAsync(SelectedBoardId, players, pawnIndices);
        // pass humanCount so Play page knows which players are bots and pawns as comma-separated indexes
        var pawnsQuery = string.Join(',', pawnIndices.Select(i => i <=0 ? 1 : i));
        Nav.NavigateTo($"/play/{gameId}?boardId={SelectedBoardId}&humanCount={HumanCount}&pawns={pawnsQuery}");
    }
}
